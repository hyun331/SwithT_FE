<template>
    <LectureDetailInfoComponent
    :lectureId=this.lectureId
    />

    <v-container>
        <v-row>
            <v-col cols="8">
                <v-tabs v-model="activeTab" style="margin-bottom: 30px;">
                    <v-tab value="lecture-info" style="font-size: 18px;">Í∞ïÏùò Ï†ïÎ≥¥</v-tab>
                    <v-tab value="tutor-info" style="font-size: 18px;">Í∞ïÏÇ¨ Ï†ïÎ≥¥</v-tab>
                    <v-tab value="tutor-review" style="font-size: 18px;">Î¶¨Î∑∞</v-tab>
                </v-tabs>
                <div class="contents-section">
                    <v-tabs-window v-model="activeTab">
                        <v-tabs-window-item value="lecture-info">
                            
                            <div class="contents-title">Í∞ïÏùò ÏÜåÍ∞ú</div>
                            
                            <div style="font-size: 18px; margin: 0px 10px 50px; color: #333; text-align: left;">
                                {{ lectureInfo?.contents }}
                            </div>
                            <hr/>
                            <div class="contents-title">Í∞ïÏùò ÏãúÍ∞Ñ</div>
                            <div v-if="lectureInfo?.lectureType === 'LECTURE'" class="date-info" >
                                <span style="font-weight: 800; margin-right: 10px;">üìÖ ÏßÑÌñâÍ∏∞Í∞Ñ </span> {{ lectureGroups[0]?.startDate }} ~ {{ lectureGroups[0]?.endDate }}
                            </div>
                            <v-row v-for="(group, index) in lectureGroups" :key="index">
                                <v-col>
                                  <div class="pa-3 groups-info" :style="{ backgroundColor: group.isAvailable === 'N'  || group.remaining === 0 ? '#f0efef' : '' }">
                                    <v-row style="padding: 20px 0">
                                      <v-col cols="3" class="align-content-center">
                                        <v-row v-if="group.isAvailable === 'N' || group.remaining === 0" class="align-center justify-center">
                                            <div class="soldout">ÎßàÍ∞ê</div>
                                        </v-row>
                                        <v-row class="align-center justify-center">
                                            <div style="font-weight: bold; font-size: 17px;">
                                                {{ `Í∞ïÏùò Í∑∏Î£π ${index + 1}` }}
                                              </div>
                                        </v-row>
                                      </v-col>
                                      <v-col cols="9" style="text-align: left; font-size: 15px">
                                        <v-row>
                                          <v-col cols="4" class="align-center justify-start" style="padding: 10px">
                                            <strong>Í∞ïÏùòÎ£å</strong>
                                          </v-col>
                                          <v-col class="d-flex align-center justify-start" style="padding: 10px">
                                            <span v-if="lectureInfo?.lectureType === 'LESSON'" style="margin-right: 7px;">1Í∞úÏõî </span>
                                             {{ formatPrice(group.price) }}Ïõê
                                          </v-col>
                                        </v-row>
                                        <v-row>
                                          <v-col cols="4" class="align-center justify-start" style="padding: 10px">
                                            <strong>Î™®ÏßëÏù∏Ïõê</strong>
                                          </v-col>
                                          <v-col class="d-flex align-center justify-start" style="padding: 10px">
                                            {{ group.participants }}Î™Ö
                                          </v-col>
                                        </v-row>
                                        
                                        <v-row>
                                          <v-col cols="4" class="d-flex align-center justify-start" style="padding: 10px">
                                            <strong>Í∞ïÏùòÏãúÍ∞Ñ</strong>
                                          </v-col>
                                          <v-col class="d-flex align-center justify-start" style="padding: 10px">
                                            <div>
                                              <div v-for="time in group.groupTimes" :key="time.groupTimeId">
                                                <span style="font-weight: bold; color: #6C97FD">{{ time.day }}ÏöîÏùº</span>
                                                {{ formatTime(time.startTime) }} ~ {{ formatTime(time.endTime) }}
                                              </div>
                                            </div>
                                          </v-col>
                                        </v-row>
                                      </v-col>
                                    </v-row>
                                  </div>
                                </v-col>
                              </v-row>
                              
                        </v-tabs-window-item>

                        <v-tabs-window-item value="tutor-info">
                            <!-- Í∞ïÏÇ¨ Ï†ïÎ≥¥ ÎÇ¥Ïö© -->
                             <v-col>
                                <v-row class="d-flex align-center justify-center">
                                    <div class="tutor-profile">
                                        <img :src="tutorInfo?.profileImage" alt="tutor profile"/>
                                    </div>
                                </v-row>

                                <v-row class="d-flex align-center justify-center">
                                    <div style="font-style: italic; font-size: 24px; margin: 20px 0"> ÏïàÎÖïÌïòÏÑ∏Ïöî.<br/>
                                        <span style="font-size: 27px; font-style: normal; font-weight: 700; color:#6C97FD;">
                                            {{ tutorInfo.name }}
                                        </span>
                                        ÌäúÌÑ∞ÏûÖÎãàÎã§.
                                    </div>
                                </v-row>
                               
                                <v-row class="d-flex align-center justify-center">
                                    <div class="tutor-info" style="padding: 20px">
                                        <v-row>
                                            <v-col cols="3" class="d-flex align-center justify-center">
                                                <span style="font-weight: bold; margin-right: 15px">ÌèâÏ†ê</span>
                                            </v-col>
                                            <v-col>
                                                <span class="mdi mdi-star" style="font-size: 18px;"> </span>
                                                {{tutorInfo.avgScore}} / 5.0
                                            </v-col>
                                        </v-row>
                                        <v-row>
                                            <v-col cols="3" class="d-flex align-center justify-center">
                                                <span style="font-weight: bold; margin-right: 15px">ÏµúÏ¢Ö ÌïôÎ†•</span>
                                            </v-col>
                                            <v-col>
                                                {{tutorInfo.education}}
                                            </v-col>
                                        </v-row>
                                        <v-row>
                                            <v-col cols="3" class="d-flex align-center justify-center">
                                                <span style="font-weight: bold; margin-right: 15px">ÏÑ±Î≥Ñ</span>
                                            </v-col>
                                            <v-col>
                                                {{ convertGender(tutorInfo.gender) }} 
                                            </v-col>
                                        </v-row>
                                        <v-row>
                                            <v-col cols="3" class="d-flex align-center justify-center">
                                                <span style="font-weight: bold; margin-right: 15px">Ïó∞ÎùΩÏ≤ò</span>
                                            </v-col>
                                            <v-col>
                                                {{tutorInfo.email}}
                                            </v-col>
                                        </v-row>
                                    </div>
                                </v-row>

                                <v-row style="margin: 20px 50px">
                                    <div style="font-size: 18px; text-align: left; padding: 30px" >{{tutorInfo.introduce}}</div>
                                </v-row>
                             </v-col>
                        </v-tabs-window-item>
                        <v-tabs-window-item value="tutor-review">
                          <ReviewListComponent :tutorId="tutorId" />
                            <!-- Î¶¨Î∑∞ ÎÇ¥Ïö© -->
                        </v-tabs-window-item>
                    </v-tabs-window>
                </div>
            </v-col>

            <v-col cols="4">
                <aside class="float-info">
                    <table border="3" class="time-table" >
                        <thead>
                          <tr>
                            <th>ÏãúÍ∞Ñ</th>
                            <th>Ïõî</th>
                            <th>Ìôî</th>
                            <th>Ïàò</th>
                            <th>Î™©</th>
                            <th>Í∏à</th>
                            <th>ÌÜ†</th>
                            <th>Ïùº</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr v-for="(hour, index) in hours" :key="index">
                            <td>{{ hour }}</td>
                            <td v-for="day in days" :key="day" :style="{ backgroundColor: schedule[day] && schedule[day][index] ? schedule[day][index].color : ''}">
                              <div v-if="schedule[day] && schedule[day][index]" style="color: #fff; font-weight: bold;">
                                {{ schedule[day][index].index }}
                              </div>
                            </td>
                          </tr>
                        </tbody>
                    </table>
                    <v-btn v-if="isLogin === true &&  userRole === 'TUTEE'" @click="openApplyModal" style="width: 90%; margin: 20px 0 10px; background-color: #0d6efd; color: #fff; font-weight: 700;">Ïã†Ï≤≠ÌïòÍ∏∞</v-btn>
                </aside>
            </v-col>
        </v-row>
        <v-snackbar v-model="snackbar.show" :color="snackbar.color">
            {{ snackbar.message }}
        </v-snackbar>
    </v-container>

    <v-dialog v-model="isApplyModalOpen" max-width="600px">
        <v-card style="padding: 40px 20px 50px; border-radius: 10px;">
            <div style="font-size: 24px; font-weight: 700; margin: auto;">Í∞ïÏùò Ïã†Ï≤≠</div>
            <v-card-text>
                <div v-for="group in lectureGroups" 
                    :key="group.lectureGroupId" 
                    @click="checkAndSelectGroup(group)"  
                    :class="[
                        'custom-option', 
                        { 
                            'selected': selectedLectureGroup && selectedLectureGroup.lectureGroupId === group.lectureGroupId, 
                            'disabled-group': group.isAvailable === 'N' || group.remaining === 0 
                        }]"
                    :style="{
                        backgroundColor: group.isAvailable === 'N' || group.remaining === 0 ? '#f0efef' : (selectedLectureGroup && selectedLectureGroup.lectureGroupId === group.lectureGroupId ? '#e7f0ff' : ''),
                        borderColor: selectedLectureGroup && selectedLectureGroup.lectureGroupId === group.lectureGroupId ? '#007bff' : '#ccc'
                    }" 
                    style="margin-top: 10px;">
                    
                    <div>
                        <span v-if="group.isAvailable === 'N' || group.remaining === 0" class="soldout">
                            ÎßàÍ∞ê
                        </span>
                        <span style="color: #000; font-weight: 700; margin: 10px">Í∞ïÏùò Í∑∏Î£π {{ group.groupIndex }}</span>
                    </div>
                </div>
    
                <!-- Í∞ïÏùò Í∑∏Î£π ÏÑ†ÌÉù Ïãú Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†• Ìèº -->
                <transition name="fade">
                    <div v-if="selectedLectureGroup" style="margin-top: 20px;">
                        <div v-if="lectureInfo?.lectureType === 'LESSON'" style="padding: 0 10px;">
                            <hr style="margin: 30px 0"/>
                            <div style="font-size: 18px; font-weight: 700; color: #5d8dfc; margin: 10px 0;">Ï∂îÍ∞Ä Ï†ïÎ≥¥ ÏûÖÎ†•</div>
                            <v-row>
                                <v-col>
                                    <label for="startDate" class="form-label">ÏãúÏûëÏùº</label>
                                    <input v-model="startDate" id="startDate" class="form-control" type="date" />
                                </v-col>
                                <!-- <v-col>
                                    <label for="endDate" class="form-label">Ï¢ÖÎ£åÏùº</label>
                                    <input v-model="endDate" class="form-control" type="date" />
                                </v-col> -->
                            </v-row>
                            <v-row>
                                <v-col>
                                    <label for="location" class="form-label">Í∞ïÏùò ÏúÑÏπò</label><br/>
                                    <v-btn style="border: 1px solid #ccc;" variant="outlined"
                                      @click="updateAddress()"> Ï£ºÏÜå Í≤ÄÏÉâ</v-btn>
                                      <span style="margin: 5px 10px; font-weight: 700;">{{this.location}}</span>
                                    <input v-model="detailAddress" id="detailAddress" class="form-control" placeholder="ÏÉÅÏÑ∏ Ï£ºÏÜåÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî" type="text" style="margin-top: 10px;"/>
                                </v-col>
                            </v-row>
                        </div>
                    </div>
                    
                </transition>
            </v-card-text>
            <v-card-actions style="justify-content: flex-end;">
                <transition name="fade">
                    <v-btn v-if="selectedLectureGroup" style="background-color: #0d6efd; color: #fff; font-weight: 700; margin-right: 10px;" @click="submitApplication();">Ïã†Ï≤≠ÌïòÍ∏∞</v-btn>
                </transition>
                <v-btn @click="closeApplyModal">Ï∑®ÏÜå</v-btn>
            </v-card-actions>
        </v-card>
    </v-dialog>

    <!-- ÎåÄÍ∏∞Ïó¥ Î™®Îã¨ -->
    <v-dialog v-model="waitingDialog" persistent max-width="600px">
        <v-card style="padding: 40px 20px 50px; border-radius: 10px; text-align: center;">
            <v-card-title class="headline">ÎåÄÍ∏∞Ïó¥ ÏÉÅÌÉú</v-card-title>
            <v-card-text>
                
                <div v-if="queueStatusMessage">{{ queueStatusMessage }}</div> <!-- ÎåÄÍ∏∞Ïó¥ ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú -->
                
                <div v-if="this.rank !== -1 && this.rank !== null && this.rank !== 0">
                    ÌòÑÏû¨ ÎåÄÍ∏∞ ÏàúÎ≤àÏùÄ <strong>{{ this.rank }}</strong>Î≤à ÏûÖÎãàÎã§.
                </div>
                
                <div v-if="this.rank == 0">Ïû†Ïãú ÌõÑ Í≤∞Ï†ú ÌéòÏù¥ÏßÄÎ°ú ÎÑòÏñ¥Í∞ëÎãàÎã§.</div>
                
                <div v-else-if="this.rank === -1 || this.rank === null">
                    ÎåÄÍ∏∞Ïó¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ëÏûÖÎãàÎã§.
                </div>
                
                <div class="caution">Ï∞ΩÏùÑ Î≤óÏñ¥ÎÇ† Ïãú ÎåÄÍ∏∞Ïó¥ÏóêÏÑú ÏàúÎ≤àÏù¥ Îí§Î°ú Î∞ÄÎ¶¨Í≤å Îê©ÎãàÎã§.</div>
            </v-card-text>
        </v-card>
    </v-dialog>
    
      <!-- YesOrNoModal -->
      <YesOrNoModal
        v-model:dialog="showPaymentModal"
        :title="paymentModalTitle"
        :contents="paymentModalContents"
        yesBtnName="Í≤∞Ï†ú"
        @confirmed="proceedPayment"
     />
</template>

<script>
/* global kakao */

import axios from 'axios';
import LectureDetailInfoComponent from '@/components/LectureDetailInfoComponent.vue';
import ReviewListComponent from '@/components/ReviewListComponent.vue';
import YesOrNoModal from "@/components/YesOrNoModal.vue";
import { jwtDecode } from 'jwt-decode'


export default {
  components: {
    LectureDetailInfoComponent,
    ReviewListComponent,
    YesOrNoModal,
  },
  data() {
    return {
    isLogin: false,
    userRole: null,
      activeTab: 'lecture-info',
      isApplyModalOpen: false, // Î™®Îã¨ Ïó¥Î¶º ÏÉÅÌÉú
      availableLectureGroups: [],
      selectedLectureGroup: null,
      startDate: null,
      endDate: null,
      location:null,
      detailAddress : null,
      days: ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'],
      hours: [
        '06:00', '07:00', '08:00', '09:00', '10:00', '11:00',
        '12:00', '13:00', '14:00', '15:00', '16:00', '17:00',
        '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '24:00'
      ],
      schedule: {},
      lectureInfo: null,
      lectureGroups: [], // Í∞ïÏùò Í∑∏Î£π Îç∞Ïù¥ÌÑ∞
      lectureLocation: '', // Í∞ïÏùò ÏúÑÏπò
      tutorInfo: null,
      tutorId: null,
      lectureId : this.$route.params.id,
      memberId: null,
      memberName: null,
      snackbar: {
            show: false,
            message: "",
            color: ""
        },
      waitingDialog: false,
      rank: null,
      queueStatusMessage: '', // ÎåÄÍ∏∞Ïó¥ ÏÉÅÌÉú Î©îÏãúÏßÄ
      showPaymentModal: false, // Î™®Îã¨ ÌëúÏãú Ïó¨Î∂Ä
      paymentModalTitle: '',
      paymentModalContents: '',
      queueRank: -1,
      getOrderData: null,
    };
  },
  created() {
    this.fetchLectureGroupInfo();
    const token = localStorage.getItem('token');
    if (token) {
      this.isLogin = true;
      this.userRole = localStorage.getItem('role');
    }
  },
  async mounted() {
    await this.fetchLectureDetail(); // Í∞ïÏùò ÏÑ∏Î∂Ä Ï†ïÎ≥¥Î•º Î®ºÏ†Ä Í∞ÄÏ†∏ÏòµÎãàÎã§.
    await this.fetchTutorInfo(); // Ïù¥ÌõÑ Í∞ïÏÇ¨ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏ÏòµÎãàÎã§.
    this.loadDaumPostcodeScript();
    this.loadKakaoMapScript();
  },
  
  methods: {
    loadDaumPostcodeScript() {
      const script = document.createElement('script');
      script.src = '//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js';
      script.onload = () => {
        this.isDaumScriptLoaded = true;
      };
      document.head.appendChild(script);
    },
    loadKakaoMapScript() {
      const script = document.createElement('script');
      script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=03a055c21377bee26ab1559dedf4af6f&libraries=services&autoload=false`;
      script.onload = () => {
        window.kakao.maps.load(() => {
          this.isKakaoScriptLoaded = true;
        });
      };
      document.head.appendChild(script);
    },
    updateAddress() {
      if (window.daum && window.daum.Postcode) {
        // eslint-disable-next-line no-undef
        new daum.Postcode({
          oncomplete: (data) => {
            this.location = data?.roadAddress;

            // Ï£ºÏÜå Í≤ÄÏÉâÌïú Í±∞ Í∏∞Î∞òÏúºÎ°ú ÏúÑÎèÑ Í≤ΩÎèÑ
            // Ï¢åÌëú Í≤ÄÏÉâÏùÑ ÏúÑÌï¥ Kakao ÏßÄÎèÑ Geocoder ÏÇ¨Ïö©
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(this.roadAddress, (result, status) => {
              if (status === kakao.maps.services.Status.OK) {
                console.log('ÏúÑÎèÑ : ' + result[0].y);
                console.log('Í≤ΩÎèÑ : ' + result[0].x);

                // ÏßÄÎèÑÏóê ÎßàÏª§Î•º Ï∂îÍ∞ÄÌïòÎäî Î°úÏßÅ
                this.initMap(result[0].y, result[0].x);
              }
            });
          }
        }).open();
      } else {
        console.error("Daum Postcode Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
      }
    },
    async fetchLectureDetail() {
      const lectureId = this.$route.params.id; // URLÏóêÏÑú Í∞ïÏùò ID Í∞ÄÏ†∏Ïò§Í∏∞
      try {
        const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture-detail/${lectureId}`);
        this.lectureInfo = response.data.result; // Í∞ÄÏ†∏Ïò® Í∞ïÏùò Ï†ïÎ≥¥Î•º Ï†ÄÏû•
        this.tutorId = this.lectureInfo.memberId;
      } catch (error) {
        console.error('Í∞ïÏùò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
      }
    },
    async fetchLectureGroupInfo() {
      try {
        const id = this.$route.params.id; // URLÏóêÏÑú Í∞ïÏùò ID Í∞ÄÏ†∏Ïò§Í∏∞
        const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture-group-info/${id}`);
        const data = response.data;

        if (data.result && Array.isArray(data.result) && data.result.length > 0) {
          // Í∞ïÏùò Í∑∏Î£π Îç∞Ïù¥ÌÑ∞Î•º lectureGroupsÏóê Ï†ÄÏû•
          this.lectureGroups = data.result.map((group, index) => ({
            lectureGroupId: group.lectureGroupId,
            startDate: group.startDate,
            endDate: group.endDate,
            price: group.price || 0,
            participants: group.participants || 1,
            isAvailable: group.isAvailable,
            remaining: group.remaining,
            groupIndex: index + 1,
            groupTimes: group.groupTimes.map(time => ({
              day: this.convertDayToKorean(time.lectureDay), // ÏöîÏùºÏùÑ ÌïúÍ∏ÄÎ°ú Î≥ÄÌôò
              startTime: time.startTime,
              endTime: time.endTime,
              groupIndex: index + 1 // Ïù∏Îç±Ïä§Î•º Í∞ïÏùò Í∑∏Î£π ÏàúÏÑúÎåÄÎ°ú Î∂ÄÏó¨
            }))
          }));
          

          // ÏãúÍ∞ÑÌëúÏóê ÎßûÎäî Ïä§ÏºÄÏ§Ñ Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑
          const allGroupTimes = data.result.flatMap((group, index) => 
            group.groupTimes.map(time => ({ ...time, groupIndex: index + 1 })) // Í∑∏Î£π Ïù∏Îç±Ïä§Î•º Ï∂îÍ∞ÄÎ°ú Î∂ÄÏó¨
          );
          this.schedule = this.formatSchedule(allGroupTimes);
        }
      } catch (error) {
        console.error('Í∞ïÏùò Í∑∏Î£π Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
      }
    },
    formatTime(time) {
      // ÏãúÍ∞ÑÏóêÏÑú ÏïûÏùò 5ÏûêÎ¶¨Îßå ÏûòÎùºÏÑú Î∞òÌôò (HH:MM)
      return time.substring(0, 5);
    },

    deleteLectureGroup(index) {
      // Í∞ïÏùò Í∑∏Î£π ÏÇ≠Ï†ú Í∏∞Îä• (Îã®ÏàúÌûà Î∞∞Ïó¥ÏóêÏÑú ÏÇ≠Ï†ú)
      this.lectureGroups.splice(index, 1);
    },
    convertDayToKorean(day) {
      const dayMap = {
        MONDAY: 'Ïõî',
        TUESDAY: 'Ìôî',
        WEDNESDAY: 'Ïàò',
        THURSDAY: 'Î™©',
        FRIDAY: 'Í∏à',
        SATURDAY: 'ÌÜ†',
        SUNDAY: 'Ïùº'
      };
      return dayMap[day] || 'ÏöîÏùº ÎØ∏ÏÉÅ';
    },
    formatSchedule(times) {
        const schedule = {};
        const dayMap = {
            MONDAY: 'Ïõî',
            TUESDAY: 'Ìôî',
            WEDNESDAY: 'Ïàò',
            THURSDAY: 'Î™©',
            FRIDAY: 'Í∏à',
            SATURDAY: 'ÌÜ†',
            SUNDAY: 'Ïùº'
        };

        const groupColors = {}; // Í∑∏Î£π Ïù∏Îç±Ïä§Î≥Ñ ÏÉâÏÉÅÏùÑ Ï†ÄÏû•

        times.forEach((time) => {
            const day = dayMap[time.lectureDay]; // ÏöîÏùº Î≥ÄÌôò
            const startHourIndex = this.hours.indexOf(time.startTime.split(':')[0] + ':00'); // ÏãúÏûë ÏãúÍ∞ÑÏùò index
            const endHourIndex = this.hours.indexOf(time.endTime.split(':')[0] + ':00'); // Ï¢ÖÎ£å ÏãúÍ∞ÑÏùò index

            // group.isAvailable Í∞íÏóê Îî∞Îùº ÏÉâÏÉÅÏùÑ Í≤∞Ï†ï
            const group = this.lectureGroups[time.groupIndex - 1]; // Í∑∏Î£π Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïù∏Îç±Ïä§ Ï°∞Ï†ï)
            let color;

            if (group.isAvailable === 'N' || group.remaining === 0) {
            color = '#f0efef'; // ÏÇ¨Ïö© Î∂àÍ∞ÄÌïú Í≤ΩÏö∞
            } else {
            // Í∑∏Î£π Ïù∏Îç±Ïä§Î°ú ÏÉâÏùÑ Ìï†ÎãπÌïòÍ≥†, Ìï¥Îãπ ÏÉâÏÉÅÏù¥ ÏóÜÏúºÎ©¥ ÏÉàÎ°≠Í≤å ÏÉùÏÑ±
            if (!groupColors[time.groupIndex]) {
                groupColors[time.groupIndex] = this.getRandomColor(); // Í∑∏Î£π Ïù∏Îç±Ïä§Î≥ÑÎ°ú Í≥†Ïú† ÏÉâÏÉÅ Ìï†Îãπ
            }
            color = groupColors[time.groupIndex]; // Ìï¥Îãπ Í∑∏Î£πÏùò ÏÉâÏÉÅ Í∞ÄÏ†∏Ïò§Í∏∞
            }

            if (!schedule[day]) {
            schedule[day] = Array(this.hours.length).fill(null); // Ìï¥Îãπ ÏöîÏùºÏóê Ïä§ÏºÄÏ§Ñ Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî
            }

            // ÏãúÏûë ÏãúÍ∞ÑÎ∂ÄÌÑ∞ Ï¢ÖÎ£å ÏãúÍ∞ÑÍπåÏßÄ ÏÉâÏÉÅ Î∞è Í∑∏Î£π Ïù∏Îç±Ïä§ ÏÑ§Ï†ï
            for (let hour = startHourIndex; hour < endHourIndex; hour++) {
            schedule[day][hour] = {
                name: 'Í∞ïÏùò',
                color: color, // Ï°∞Í±¥Ïóê Îî∞Î•∏ ÏÉâÏÉÅ Ï†ÅÏö©
                index: time.groupIndex // Í∑∏Î£π Ïù∏Îç±Ïä§
            };
            }
        });
        return schedule;
},
getRandomColor() {
    const colors = ['#d0e2ff', '#9ec5fe', '#6ea8fe', '#3d8bfd', '#0d6efd', '#2f6fd4', '#bad2f8', '#abc3ea', '#7fa3dd', '#5982c4', '#426caf'];
    const randomIndex = Math.floor(Math.random() * colors.length);
    return colors[randomIndex];
},
async fetchTutorInfo() {
    try {
    const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/member-service/public-infoGet/${this.tutorId}`);
    this.tutorInfo = response.data.result; // Í∞ïÏÇ¨ Ï†ïÎ≥¥Î•º Ï†ÄÏû•
    console.log(this.tutorInfo);
    } catch (error) {
    console.error('Í∞ïÏÇ¨ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§:', error);
    }
},
convertGender(gender) {
    return gender === 'MAN' ? 'ÎÇ®ÏÑ±' : 'Ïó¨ÏÑ±';
},
formatPrice(value) {
    if (!value) return '0';
    return new Intl.NumberFormat('ko-KR').format(value);
},
openApplyModal() {
    this.isApplyModalOpen = true;
},
closeApplyModal() {
    this.isApplyModalOpen = false;
    this.selectedLectureGroup = null;
    this.startDate = null;
    this.endDate = null;
    this.lectureLocation = '';
    this.location = null;
    this.detailAddress=null;
    
},
closeWaitingDialog() {
    this.waitingDialog = false;
    this.sendDeleteQueue();
},
sendDeleteQueue() {
    axios.post(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture-delete-queue`, null, { 
        params: this.getOrderData
    });
    
},
selectLectureGroup(group) {
    this.selectedLectureGroup = group;
    console.log("ÏÑ†ÌÉùÌïú Í∞ïÏùò Í∑∏Î£π ÏïÑÏù¥Îîî:" + this.selectedLectureGroup.lectureGroupId) // Ïûò Îì§Ïñ¥Ïò¥
},

async submitApplication() {

    this.token = localStorage.getItem('token');
    this.memberId = localStorage.getItem('id');
    this.memberName = localStorage.getItem('name');

    console.log(this.lectureInfo.lectureType);

    // LECTURE Ïã†Ï≤≠ Î°úÏßÅ
    if (this.lectureInfo.lectureType === "LECTURE") {
    
        const requestData = {
            lectureGroupId: this.selectedLectureGroup.lectureGroupId, // ÏÑ†ÌÉùÎêú Í∞ïÏùò Í∑∏Î£π ID
            memberId: this.memberId, // ÏöîÏ≤≠Ìï† Îïå ÌïÑÏöîÌïú memberId
            memberName: this.memberName, // ÏöîÏ≤≠Ìï† Îïå ÌïÑÏöîÌïú memberName
        };

        try {
            // ÎåÄÍ∏∞Ïó¥Ïóê ÎÑ£Í∏∞ (lecture-add-queue)
            await axios.post(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture-add-queue`, null, { 
                params: requestData // ÏøºÎ¶¨ ÌååÎùºÎØ∏ÌÑ∞Î°ú Ï†ÑÎã¨
            });
            console.log("this.rank:" + this.rank);
            this.waitingDialog = true;  // ÎåÄÍ∏∞Ïó¥ Î™®Îã¨ Ïó¥Í∏∞

            this.getOrderData = {
                lectureGroupId: this.selectedLectureGroup.lectureGroupId,
                memberId: this.memberId,
            };

            try {
                while(this.rank !== 0 && this.rank !== -1) {
                    const response = await axios.get(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture-get-order`, { 
                        params: this.getOrderData
                    });

                    this.rank = response.data.result;
                    console.log("ÌòÑÏû¨ ÎåÄÍ∏∞Ïó¥ ÏàúÏúÑ: " + this.rank);

                    // 3Ï¥à ÎåÄÍ∏∞
                    await new Promise(resolve => setTimeout(resolve, 3000)); 
                }

                this.closeWaitingDialog();
                if (this.selectedLectureGroup.price === 0) {
                    this.processFreeLesson();
                } else {
                    // Í≤∞Ï†ú Î°úÏßÅ Ïã§Ìñâ
                    this.confirmPayment();
                }

            } catch (error) {
                this.snackbar = { show: true, message: "Í∞ïÏùò Ïã†Ï≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§", color: "error" };
                this.closeApplyModal();
                this.waitingDialog = false;
            }

        } catch (error) {
            this.snackbar = { show: true, message: "Í∞ïÏùò Ïã†Ï≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§", color: "error" };
            this.closeApplyModal();
            this.waitingDialog = false;
        }

        
    }

    // LESSON Ïã†Ï≤≠ Î°úÏßÅ
    else if (this.lectureInfo.lectureType === "LESSON") {

        // ÌïÑÏàò ÏûÖÎ†• Í∞í Ï≤¥ÌÅ¨
        if (!this.startDate || !this.location) {
            this.snackbar = { show: true, message: "ÏãúÏûëÏùºÍ≥º ÏàòÏóÖ ÏúÑÏπòÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.", color: "error" };
            return;
        }

        // endDateÎ•º startDateÏùò Ìïú Îã¨ Îí§Î°ú ÏÑ§Ï†ï
        const start = new Date(this.startDate);
        const end = new Date(start);
        end.setMonth(start.getMonth() + 1); // Ìïú Îã¨ Îí§Î°ú ÏÑ§Ï†ï
        this.endDate = end.toISOString().split('T')[0]; // YYYY-MM-DD ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
        
        console.log(this.location + this.detailAddress)
        const requestData = {
            lectureGroupId: this.selectedLectureGroup.lectureGroupId, // ÏÑ†ÌÉùÎêú Í∞ïÏùò Í∑∏Î£π ID
            startDate: this.startDate, // ÏãúÏûëÏùº
            endDate: this.endDate, // Ï¢ÖÎ£åÏùº
            location: this.location, // Í∞ïÏùò ÏúÑÏπò
            detailAddress: this.detailAddress, // Í∞ïÏùò ÏúÑÏπò
        };

        try {
            await axios.post(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/single-lecture-apply`, requestData, {
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            this.snackbar = { show: true, message: "Í∞ïÏùò Ïã†Ï≤≠Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.", color: "success" };
            this.closeApplyModal();
            // location.reload(); // ÌéòÏù¥ÏßÄ ÏÉàÎ°ú Í≥†Ïπ®
        } catch (error) {
            alert(error.response.data.error_message);
            console.error("Í∞ïÏùò Ïã†Ï≤≠ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:", error);
            this.snackbar = { show: true, message: "Í∞ïÏùò Ïã†Ï≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.", color: "error" };
        }
    }
},
checkAndSelectGroup(group) {
    console.log('Í∞ïÏùò Í∑∏Î£π ÏÉÅÌÉú:', group.isAvailable, 'ÏûîÏó¨ÏÑù:', group.remaining);
    
    if (group.isAvailable !== 'N' && group.remaining > 0) {
        this.selectLectureGroup(group);
    } else {
        console.log('ÏÑ†ÌÉùÌï† Ïàò ÏóÜÎäî Í∞ïÏùò Í∑∏Î£πÏûÖÎãàÎã§.');
    }
},
confirmPayment() {
    this.paymentModalTitle = `${this.lectureInfo.title} Í≤∞Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
    this.paymentModalContents = "Í≤∞Ï†úÎ•º ÏßÑÌñâÌïòÎ†§Î©¥ Í≤∞Ï†ú Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.";
    this.showPaymentModal = true; // Í≤∞Ï†ú ÌôïÏù∏ Î™®Îã¨ÏùÑ Ïó∂
},
async proceedPayment() {
    this.showPaymentModal = false; // Î™®Îã¨ Îã´Í∏∞
    try {
        this.initiatePayment(); // Í≤∞Ï†ú ÏßÑÌñâ
    } catch (error) {
        console.error('Í≤∞Ï†ú ÏöîÏ≤≠ Ï§ë Ïò§Î•ò Î∞úÏÉù:', error);
    }
},
initiatePayment() {

    const IMP = window.IMP;  // ÏïÑÏûÑÌè¨Ìä∏ Ï†ÑÏó≠ Í∞ùÏ≤¥
    IMP.init("imp00575764"); // ÏïÑÏûÑÌè¨Ìä∏ ÏÉÅÏ†ê Í≥†Ïú†ÏΩîÎìúÎ°ú Ï¥àÍ∏∞Ìôî


    const paymentData = {
        pg: "html5_inicis", // Í≤∞Ï†ú PGÏÇ¨
        pay_method: "card", // Í≤∞Ï†ú Î∞©Î≤ï
        merchant_uid: `merchant_${new Date().getTime()}`, // Ï£ºÎ¨∏Î≤àÌò∏
        name: this.lectureInfo.title, // Í≤∞Ï†ú ÎÇ¥Ïó≠
        amount: this.selectedLectureGroup.price, // Í≤∞Ï†ú Í∏àÏï°
        buyer_email: jwtDecode(localStorage.getItem('token')).email,
        buyer_name: jwtDecode(localStorage.getItem('token')).name,
        buyer_tel: "",
    };

    this.closeApplyModal();
    console.log(paymentData);

    IMP.request_pay(paymentData, this.processPayment); // Í≤∞Ï†ú ÏöîÏ≤≠
},
async processPayment(rsp) {

    console.log("processPayment");
    try {
        this.memberId = localStorage.getItem('id');
        if (rsp.success) {
            const data = {
                impUid: rsp.imp_uid, // ÏïÑÏûÑÌè¨Ìä∏ Í±∞Îûò Í≥†Ïú†Î≤àÌò∏
                title: this.lectureInfo.title,
                price: this.lectureInfo.price,
                memberId: this.memberId,
                lectureGroupId: this.selectedLectureGroup.lectureGroupId,
            };
            console.log(data);

            await axios.post(`${process.env.VUE_APP_API_BASE_URL}/payment-service/complete`, data);
            alert("Í≤∞Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!");
        }
    } catch (error) {
        console.log("Í≤∞Ï†ú Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
    }
},
async processFreeLesson(){
    console.log("Î¨¥Î£å Í∞ïÏó∞")
    const lectureGroupId = this.selectedLectureGroup.lectureGroupId
    try{
        const response = await axios.post(`${process.env.VUE_APP_API_BASE_URL}/lecture-service/lecture/after-paid?lectureGroupId=${lectureGroupId}&memberId=${this.memberId}`);
        console.log("Ïã†Ï≤≠Îê®", response.data)
    } catch(error){
        console.log("Í≤∞Ï†ú Ï≤òÎ¶¨ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
    }
},
}}
</script>


<style scoped>

.v-container {
    width: 70vw;
}
.contents-section {
    /*display: flex;*/
    justify-content: space-between;
    gap: 20px;
}

.float-info {
    width: 300px;
    background-color: #fff;
    position: sticky;
    border: 2px solid #f0efef;
    border-radius: 10px;
    padding: 30px 5px;
    margin-top: 60px; /* ÌôîÎ©¥ ÏÉÅÎã®Í≥º 40px Í±∞Î¶¨ */
    top: 60px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä */
}

.time-table {
    margin: auto;
    width: 250px;
    
}

table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #cdcdcd !important;
}
  
th, td {
    padding: 5px;
    text-align: center;
    font-size: 11px;
    border: 1px solid #e6e4e4 !important;
}
  
td {
    height: 10px;
}
.groups-info {
    border: 1px solid #f0efef;
    border-radius: 10px;
}
.contents-title {
    text-align: left;
    margin: 20px 10px;
    font-size: 22px;
    font-weight: 700;
}
.tutor-profile img{
    width: 200px;
    height: 200px;
    border-radius: 50%;
}
.tutor-info {
     background-color: #e1e8fa;
     border-radius: 10px;
     width: 80%;
     padding: 20px 50px;
     font-size: 17px;
     text-align: left;
}
.date-info {
    background-color: #d0e2ff;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    font-size: 18px;
    color: #333;
    text-align: left;

}
.soldout {
    display: inline-block;
    text-align: center;
    width: 50px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 15px;
    color: #fff;
    background-color: #666;
}
.custom-option {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.custom-option.selected {
    border-color: #007bff !important; /* ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ ÌÖåÎëêÎ¶¨ ÏÉâÏÉÅ */
    background-color: #e7f0ff !important; /* ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ Î∞∞Í≤Ω ÏÉâÏÉÅ */
    transform: scale(1.01) !important; /* ÏÑ†ÌÉùÎêú Í≤ΩÏö∞ ÏÇ¥Ïßù ÌôïÎåÄ */
}

.disabled-group {
    opacity: 0.5; /* ÎπÑÌôúÏÑ±ÌôîÎêú Í∑∏Î£πÏóê ÎåÄÌïú Ïä§ÌÉÄÏùº */
    pointer-events: none; /* ÌÅ¥Î¶≠ ÎπÑÌôúÏÑ±Ìôî */
}
.fade-enter-active, .fade-leave-active {
    transition: opacity 0.4s ease;
}
.fade-enter, .fade-leave-to /* .fade-leave-active in <2.1.8 */ {
    opacity: 0;
}
.caution {
    font-size: 14px;
    color: red;
}

</style>